<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Links</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #f7f7fb; }
    header { padding: 16px 20px; background: white; border-bottom: 1px solid #e9e9f2; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    h1 { margin: 0; font-size: 18px; }
    main { padding: 18px 20px; max-width: 980px; margin: 0 auto; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .card { background: white; border: 1px solid #e9e9f2; border-radius: 14px; padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,.03); }
    .title { font-weight: 700; margin: 0 0 6px 0; }
    .cat { font-size: 12px; opacity: .7; margin-bottom: 10px; }
    a.btn { display:inline-block; text-decoration:none; padding: 10px 12px; border-radius: 10px; border: 1px solid #dfe0f2; background: #fafafe; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { cursor:pointer; border:1px solid #dfe0f2; background:white; border-radius:10px; padding:9px 12px; }
    button.primary { background:#111827; color:white; border-color:#111827; }
    button.danger { background:#fee2e2; border-color:#fecaca; }
    input, select { width: 100%; box-sizing:border-box; padding: 10px 12px; border-radius: 10px; border:1px solid #dfe0f2; background:white; }
    label { font-size: 12px; opacity:.75; display:block; margin: 10px 0 6px; }
    .muted { opacity:.75; font-size: 12px; }
    .hidden { display:none !important; }
    .backdrop { position:fixed; inset:0; background: rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; padding:18px; }
    .modal { width: min(520px, 100%); background:white; border-radius: 16px; border:1px solid #e9e9f2; padding: 14px; }
    .modal h2 { margin: 6px 0 6px; font-size: 16px; }
    .modal .actions { display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #dfe0f2; background:#fafafe; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>Links</h1>
    <span id="modePill" class="pill hidden">SUPERADMIN</span>
  </div>
  <div class="row">
    <button id="adminBtn">Admin</button>
    <button id="logoutBtn" class="hidden">Esci</button>
  </div>
</header>

<main>
  <div id="status" class="muted"></div>
  <div id="linksGrid" class="grid" style="margin-top:12px;"></div>

  <section id="adminPanel" class="hidden" style="margin-top:18px;">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="title">Gestione Links</div>
          <div class="muted">Solo SUPERADMIN può creare/modificare/eliminare e vedere inattivi.</div>
        </div>
        <button id="refreshAdminBtn">Aggiorna</button>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="newLinkBtn" class="primary">Nuovo link</button>
      </div>
      <div id="adminList" style="margin-top:12px;"></div>
    </div>
  </section>
</main>

<div id="adminModal" class="backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <h2>Accesso Superadmin</h2>
    <div class="muted">Inserisci la SUPERADMIN KEY. Non verrà mai inserita nell’URL.</div>
    <label for="keyInput">SUPERADMIN KEY</label>
    <input id="keyInput" type="password" placeholder="••••••••••••••••" />
    <div class="actions">
      <button id="closeModalBtn">Annulla</button>
      <button id="saveKeyBtn" class="primary">Entra</button>
    </div>
  </div>
</div>

<div id="editModal" class="backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="editTitle">Modifica link</h2>
    <label>Titolo</label><input id="fTitle" />
    <label>Categoria</label><input id="fCat" />
    <label>URL</label><input id="fUrl" />
    <label>Ordine</label><input id="fOrder" type="number" />
    <label>Attivo</label>
    <select id="fActive"><option value="1">Sì</option><option value="0">No</option></select>
    <div class="actions">
      <button id="cancelEditBtn">Annulla</button>
      <button id="deleteBtn" class="danger hidden">Elimina</button>
      <button id="saveEditBtn" class="primary">Salva</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = "/api";
  const STORAGE_SUPER = "superadmin_key";
  const $ = (id) => document.getElementById(id);
  function setStatus(msg) { $("status").textContent = msg || ""; }

  async function apiFetch(path, { method="GET", body, query } = {}) {
    const url = new URL(API_BASE + path, location.origin);
    if (query) for (const [k,v] of Object.entries(query)) url.searchParams.set(k, v);
    const superKey = (localStorage.getItem(STORAGE_SUPER) || "").trim();
    const res = await fetch(url.toString(), {
      method,
      headers: { "content-type":"application/json", ...(superKey ? {"x-superadmin-key": superKey} : {}) },
      body: body ? JSON.stringify(body) : undefined
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
    return data;
  }

  function openModal(el){ el.classList.remove("hidden"); }
  function closeModal(el){ el.classList.add("hidden"); }
  function isSuperadmin(me){ return me && me.role === "superadmin"; }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  function renderPublic(items){
    const grid=$("linksGrid"); grid.innerHTML="";
    for(const it of items){
      const card=document.createElement("div"); card.className="card";
      card.innerHTML = `<div class="title">${escapeHtml(it.title)}</div>
        <div class="cat">${escapeHtml(it.category||"")}</div>
        <a class="btn" href="${escapeAttr(it.url)}" target="_blank" rel="noopener noreferrer">Apri</a>`;
      grid.appendChild(card);
    }
  }

  function renderAdminList(items){
    const wrap=$("adminList"); wrap.innerHTML="";
    if(!items.length){ wrap.innerHTML=`<div class="muted">Nessun link.</div>`; return; }
    for(const it of items){
      const row=document.createElement("div"); row.className="card"; row.style.marginBottom="10px";
      row.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div class="title">${escapeHtml(it.title)} ${it.active ? "" : '<span class="pill">INATTIVO</span>'}</div>
            <div class="muted">${escapeHtml(it.category||"")} • ordine ${it.sort_order}</div>
            <div class="muted">${escapeHtml(it.url)}</div>
          </div>
          <div class="row"><button data-edit="${it.id}">Modifica</button></div>
        </div>`;
      row.querySelector("[data-edit]").addEventListener("click", () => openEdit(it));
      wrap.appendChild(row);
    }
  }

  let lastMe=null, adminItems=[];
  async function loadPublic(){
    setStatus("Caricamento…");
    const data=await apiFetch("/links");
    lastMe=data.me; renderPublic(data.items||[]);
    setStatus(""); updateAdminVisibility();
  }
  async function loadAdmin(){
    const data=await apiFetch("/links",{query:{all:1}});
    lastMe=data.me; adminItems=data.items||[];
    renderAdminList(adminItems); updateAdminVisibility();
  }
  function updateAdminVisibility(){
    const superMode=isSuperadmin(lastMe);
    $("adminPanel").classList.toggle("hidden", !superMode);
    $("logoutBtn").classList.toggle("hidden", !superMode);
    $("modePill").classList.toggle("hidden", !superMode);
  }

  $("adminBtn").addEventListener("click", ()=>{ $("keyInput").value=""; openModal($("adminModal")); setTimeout(()=>$("keyInput").focus(),50); });
  $("closeModalBtn").addEventListener("click", ()=>closeModal($("adminModal")));
  $("saveKeyBtn").addEventListener("click", async ()=>{
    const key=($("keyInput").value||"").trim(); if(!key) return;
    localStorage.setItem(STORAGE_SUPER, key); closeModal($("adminModal"));
    try{ await loadAdmin(); await loadPublic(); }
    catch(e){ localStorage.removeItem(STORAGE_SUPER); lastMe=null; updateAdminVisibility(); alert("Key non valida."); await loadPublic(); }
  });
  $("logoutBtn").addEventListener("click", async ()=>{ localStorage.removeItem(STORAGE_SUPER); lastMe=null; updateAdminVisibility(); await loadPublic(); });
  $("refreshAdminBtn").addEventListener("click", async ()=>{ try{ await loadAdmin(); }catch(e){ alert(e.message); } });

  let editingId=null;
  function openEdit(item){
    editingId=item?.id ?? null;
    $("editTitle").textContent = editingId ? "Modifica link" : "Nuovo link";
    $("fTitle").value=item?.title||""; $("fCat").value=item?.category||""; $("fUrl").value=item?.url||"";
    $("fOrder").value=item?.sort_order ?? 0; $("fActive").value=item?.active ? "1":"0";
    $("deleteBtn").classList.toggle("hidden", !editingId);
    openModal($("editModal"));
  }
  $("newLinkBtn").addEventListener("click", ()=>openEdit(null));
  $("cancelEditBtn").addEventListener("click", ()=>closeModal($("editModal")));
  $("saveEditBtn").addEventListener("click", async ()=>{
    const payload={ title:$("fTitle").value.trim(), category:$("fCat").value.trim(), url:$("fUrl").value.trim(),
      sort_order: parseInt($("fOrder").value||"0",10)||0, active: $("fActive").value==="1" };
    try{
      if(!payload.title || !payload.url) return alert("Titolo e URL sono richiesti.");
      if(!editingId) await apiFetch("/links",{method:"POST",body:payload});
      else await apiFetch(`/links/${editingId}`,{method:"PUT",body:payload});
      closeModal($("editModal")); await loadAdmin(); await loadPublic();
    }catch(e){ alert(e.message); }
  });
  $("deleteBtn").addEventListener("click", async ()=>{
    if(!editingId) return; if(!confirm("Eliminare questo link?")) return;
    try{ await apiFetch(`/links/${editingId}`,{method:"DELETE"}); closeModal($("editModal")); await loadAdmin(); await loadPublic(); }
    catch(e){ alert(e.message); }
  });

  loadPublic().catch(e=>setStatus("Errore: "+e.message));
</script>
</body></html>
